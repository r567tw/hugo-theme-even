<!DOCTYPE html>
<html lang="{{ .Site.Language }}">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>
        {{- block "title" . -}}
        {{ if .IsPage }}{{ .Title }} - {{ .Site.Title }}{{ else }}{{ .Site.Title }}{{ end }}
        {{- end -}}
    </title>
    {{ partial "head.html" . }}
</head>

<body>
    {{ partial "slideout.html" . }}
    <div class="container" id="mobile-panel">
        {{ if not .Params.hideHeaderAndFooter -}}
        <header id="header" class="header">
            {{ partial "header.html" . }}
        </header>
        {{- end }}

        <main id="main" class="main">
            <div class="content-wrapper">
                <h1 class="post-title">Search: 目前無法支援中文</h1>
                <div class="input-group">
                    <div>
                        <input class="search" type="search" id="search-input" placeholder=""
                            oninput="showSearchResults()" />
                    </div>
                </div>
                <br />
                <ul id="list" class="search-result"></ul> <!-- this list is for rendering the results -->
            </div>
        </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.0.2/lunr.js"></script>
    <script>
        var searchElem = document.getElementById("search-input");
        var posts;
        function loadSearch() {
            // call the index.json file from server by http get request
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        if (data) {
                            posts = data.items; // load json data
                            // console.log(posts)
                        }
                    } else {
                        console.log(xhr.responseText);
                    }
                }
            };
            xhr.open('GET', "/index.json");
            xhr.send();
        }
        loadSearch(); // call loadsearch to load the json file
        function showSearchResults() {
            var query = searchElem.value || ''; // get the value from input
            var searchString = query
            // var searchString = query.replace(/[^\w\s]/gi, ''); // clear white spaces
            console.log(searchString)
            var target = document.getElementById('list'); // target the ul list to render the results
            var postsByTitle = posts.reduce((acc, curr) => { // map lunr search index to your articles
                acc[curr.title] = curr;
                return acc;
            }, {}
            );
            // build lunr index file
            var index = lunr(function () {
                this.ref('title')
                this.field('content')
                posts.forEach(function (doc) {
                    this.add(doc)
                }, this)
            });
            // search in lunr index
            if (searchString && searchString != '') {
                var matches = index.search(searchString);
                var matchPosts = [];
                matches.forEach((m) => {
                    matchPosts.push(postsByTitle[m.ref]);
                });
                if (matchPosts.length > 0) {
                    // match found with input text and lunr index
                    target.innerHTML = matchPosts.map(function (p) {
                        if (p != undefined) {
                            return `<li>
                        <a href="${p.url}" target="_blank"> ${p.title}</a>
                        </li>`;
                        }
                    }).join('');
                } else {
                    // if no results found, then render a general message
                    target.innerHTML = `<br><h2>No search results found</h2>`;
                };
            } else {
                target.innerHTML = ''
            }
        };
    </script>
    {{ partial "scripts.html" . }}
</body>

</html>